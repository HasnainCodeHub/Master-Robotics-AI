"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[2676],{5415(e,s,r){r.r(s),r.d(s,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>n,toc:()=>c});const n=JSON.parse('{"id":"module-2/chapter-2-topics-pubsub","title":"Chapter 2: Topics and Publishers/Subscribers","description":"Chapter Goal","source":"@site/docs/module-2/chapter-2-topics-pubsub.md","sourceDirName":"module-2","slug":"/module-2/chapter-2-topics-pubsub","permalink":"/Master-Robotics-AI/textbook/module-2/chapter-2-topics-pubsub","draft":false,"unlisted":false,"editUrl":"https://github.com/HasnainCodeHub/Master-Robotics-AI/tree/main/docs/docs/module-2/chapter-2-topics-pubsub.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"id":"chapter-2-topics-pubsub","title":"Chapter 2: Topics and Publishers/Subscribers","sidebar_label":"2. Topics & Pub/Sub","sidebar_position":3},"sidebar":"textbookSidebar","previous":{"title":"1. ROS 2 Architecture","permalink":"/Master-Robotics-AI/textbook/module-2/chapter-1-ros2-architecture"},"next":{"title":"3. Services","permalink":"/Master-Robotics-AI/textbook/module-2/chapter-3-services"}}');var i=r(4848),t=r(8453);const a={id:"chapter-2-topics-pubsub",title:"Chapter 2: Topics and Publishers/Subscribers",sidebar_label:"2. Topics & Pub/Sub",sidebar_position:3},l="Chapter 2: Topics and Publishers/Subscribers",o={},c=[{value:"Chapter Goal",id:"chapter-goal",level:2},{value:"Learning Objectives",id:"learning-objectives",level:2},{value:"The Perception-Action Loop as a Topic Network",id:"the-perception-action-loop-as-a-topic-network",level:2},{value:"Publishers: Streaming Sensor Data",id:"publishers",level:2},{value:"Basic Publisher Structure",id:"basic-publisher-structure",level:3},{value:"Key Publisher Concepts",id:"key-publisher-concepts",level:3},{value:"Subscribers: Processing Sensor Data",id:"subscribers",level:2},{value:"Basic Subscriber Structure",id:"basic-subscriber-structure",level:3},{value:"Callback Execution Model",id:"callback-execution-model",level:3},{value:"Standard Message Types",id:"message-types",level:2},{value:"Common Sensor Messages",id:"common-sensor-messages",level:3},{value:"Command Messages",id:"command-messages",level:3},{value:"Message Headers",id:"message-headers",level:3},{value:"QoS Configuration in Practice",id:"qos-practice",level:2},{value:"QoS Profiles",id:"qos-profiles",level:3},{value:"Custom QoS",id:"custom-qos",level:3},{value:"QoS Decision Framework",id:"qos-decision-framework",level:3},{value:"Debugging Topic Communication",id:"debugging",level:2},{value:"Check Topic Existence",id:"check-topic-existence",level:3},{value:"Check Message Type",id:"check-message-type",level:3},{value:"Monitor Data",id:"monitor-data",level:3},{value:"Diagnose QoS Issues",id:"diagnose-qos-issues",level:3},{value:"Command Velocity Publisher Example",id:"cmd-vel-example",level:2},{value:"Summary",id:"summary",level:2},{value:"Self-Assessment Questions",id:"self-assessment-questions",level:2},{value:"What&#39;s Next",id:"whats-next",level:2}];function d(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.header,{children:(0,i.jsx)(s.h1,{id:"chapter-2-topics-and-publisherssubscribers",children:"Chapter 2: Topics and Publishers/Subscribers"})}),"\n",(0,i.jsx)(s.h2,{id:"chapter-goal",children:"Chapter Goal"}),"\n",(0,i.jsxs)(s.p,{children:["By the end of this chapter, you will be able to ",(0,i.jsx)(s.strong,{children:"implement the publish/subscribe pattern for continuous data streams"}),", with emphasis on sensor data handling and appropriate QoS configuration based on physical sensor characteristics."]}),"\n",(0,i.jsx)(s.h2,{id:"learning-objectives",children:"Learning Objectives"}),"\n",(0,i.jsx)(s.p,{children:"After completing this chapter, you will be able to:"}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"ID"}),(0,i.jsx)(s.th,{children:"Objective"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"2.1"}),(0,i.jsx)(s.td,{children:"Implement a publisher node that publishes sensor data at a specified rate with appropriate QoS"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"2.2"}),(0,i.jsx)(s.td,{children:"Implement a subscriber node that processes sensor data with callbacks and handles message timing"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"2.3"}),(0,i.jsx)(s.td,{children:"Select and use standard message types for common sensor data"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"2.4"}),(0,i.jsx)(s.td,{children:"Configure QoS profiles based on sensor characteristics"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"2.5"}),(0,i.jsx)(s.td,{children:"Debug topic communication issues using command-line tools"})]})]})]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"the-perception-action-loop-as-a-topic-network",children:"The Perception-Action Loop as a Topic Network"}),"\n",(0,i.jsxs)(s.p,{children:["In Module 1, you learned that robots operate through continuous perception-action loops. In ROS 2, these loops are implemented as ",(0,i.jsx)(s.strong,{children:"topic networks"}),"\u2014publishers streaming data to subscribers."]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"Sensor (physical)          ROS 2 Node              ROS 2 Topic\r\n      \u2502                        \u2502                        \u2502\r\n      \u2502  Light/Sound/Force     \u2502                        \u2502\r\n      \u25bc                        \u25bc                        \u25bc\r\n  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           /camera/image\r\n  \u2502Camera \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502camera_node\u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\r\n  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   analog    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    Image msg\r\n                                              \u2502\r\n                                              \u25bc\r\n                                        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n                                        \u2502detector   \u2502\r\n                                        \u2502_node      \u2502\r\n                                        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,i.jsx)(s.p,{children:"Each sensor becomes a publisher. Each processing stage subscribes to inputs and publishes outputs."}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"publishers",children:"Publishers: Streaming Sensor Data"}),"\n",(0,i.jsx)(s.p,{children:"A publisher sends messages to a topic. Let's implement an IMU publisher."}),"\n",(0,i.jsx)(s.h3,{id:"basic-publisher-structure",children:"Basic Publisher Structure"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:'#!/usr/bin/env python3\r\n"""\r\nIMU Publisher Node\r\n\r\nPublishes simulated IMU data at 100 Hz with Gaussian noise.\r\nPhysical grounding: Noise characteristics from M1 Chapter 2.\r\n"""\r\n\r\nimport rclpy\r\nfrom rclpy.node import Node\r\nfrom rclpy.qos import QoSProfile, ReliabilityPolicy, HistoryPolicy\r\nfrom sensor_msgs.msg import Imu\r\nimport numpy as np\r\n\r\n\r\nclass ImuPublisher(Node):\r\n    """Publishes IMU data with realistic noise characteristics."""\r\n\r\n    def __init__(self):\r\n        super().__init__(\'imu_publisher\')\r\n\r\n        # Physical parameters from M1 sensor specifications\r\n        self.publish_rate_hz = 100.0  # 100 Hz update rate\r\n        self.accel_noise_stddev = 0.01  # m/s\xb2 (from datasheet)\r\n        self.gyro_noise_stddev = 0.001  # rad/s (from datasheet)\r\n\r\n        # QoS: Best-effort for high-rate sensor data (M1 Chapter 2)\r\n        # - IMU data is high rate, latest value matters most\r\n        # - Missing one sample at 100 Hz is acceptable\r\n        qos_profile = QoSProfile(\r\n            reliability=ReliabilityPolicy.BEST_EFFORT,\r\n            history=HistoryPolicy.KEEP_LAST,\r\n            depth=1\r\n        )\r\n\r\n        # Create publisher\r\n        self.publisher = self.create_publisher(\r\n            Imu,\r\n            \'imu/data\',\r\n            qos_profile\r\n        )\r\n\r\n        # Create timer for periodic publishing\r\n        timer_period = 1.0 / self.publish_rate_hz\r\n        self.timer = self.create_timer(timer_period, self.publish_imu)\r\n\r\n        self.get_logger().info(\r\n            f\'IMU publisher started at {self.publish_rate_hz} Hz\'\r\n        )\r\n\r\n    def publish_imu(self):\r\n        """Publish IMU message with simulated noise."""\r\n        msg = Imu()\r\n\r\n        # Timestamp\r\n        msg.header.stamp = self.get_clock().now().to_msg()\r\n        msg.header.frame_id = \'imu_link\'\r\n\r\n        # Simulated acceleration with Gaussian noise\r\n        # True value is gravity (0, 0, 9.81), add noise\r\n        msg.linear_acceleration.x = np.random.normal(0, self.accel_noise_stddev)\r\n        msg.linear_acceleration.y = np.random.normal(0, self.accel_noise_stddev)\r\n        msg.linear_acceleration.z = np.random.normal(9.81, self.accel_noise_stddev)\r\n\r\n        # Simulated angular velocity with noise\r\n        msg.angular_velocity.x = np.random.normal(0, self.gyro_noise_stddev)\r\n        msg.angular_velocity.y = np.random.normal(0, self.gyro_noise_stddev)\r\n        msg.angular_velocity.z = np.random.normal(0, self.gyro_noise_stddev)\r\n\r\n        # Covariance matrices (diagonal, from noise stddev)\r\n        accel_var = self.accel_noise_stddev ** 2\r\n        gyro_var = self.gyro_noise_stddev ** 2\r\n\r\n        msg.linear_acceleration_covariance = [\r\n            accel_var, 0.0, 0.0,\r\n            0.0, accel_var, 0.0,\r\n            0.0, 0.0, accel_var\r\n        ]\r\n\r\n        msg.angular_velocity_covariance = [\r\n            gyro_var, 0.0, 0.0,\r\n            0.0, gyro_var, 0.0,\r\n            0.0, 0.0, gyro_var\r\n        ]\r\n\r\n        self.publisher.publish(msg)\r\n\r\n\r\ndef main(args=None):\r\n    rclpy.init(args=args)\r\n    node = ImuPublisher()\r\n\r\n    try:\r\n        rclpy.spin(node)\r\n    except KeyboardInterrupt:\r\n        pass\r\n    finally:\r\n        node.destroy_node()\r\n        rclpy.shutdown()\r\n\r\n\r\nif __name__ == \'__main__\':\r\n    main()\n'})}),"\n",(0,i.jsx)(s.h3,{id:"key-publisher-concepts",children:"Key Publisher Concepts"}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Timer-based publishing"}),": The timer calls ",(0,i.jsx)(s.code,{children:"publish_imu()"})," at the specified rate. This matches the physical sensor's update rate."]}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Message timestamps"}),": Every message should have a timestamp in the header. This enables:"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Latency measurement (compare stamp to receive time)"}),"\n",(0,i.jsx)(s.li,{children:"Synchronization with other sensors"}),"\n",(0,i.jsx)(s.li,{children:"Detecting stale data"}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Covariance matrices"}),": For sensor messages, covariance captures uncertainty. This connects directly to M1's noise models\u2014subscribers can use this for sensor fusion."]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"subscribers",children:"Subscribers: Processing Sensor Data"}),"\n",(0,i.jsx)(s.p,{children:"A subscriber receives messages from a topic and processes them in callbacks."}),"\n",(0,i.jsx)(s.h3,{id:"basic-subscriber-structure",children:"Basic Subscriber Structure"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:"#!/usr/bin/env python3\r\n\"\"\"\r\nIMU Subscriber Node\r\n\r\nSubscribes to IMU data and monitors timing.\r\nPhysical grounding: Detects when sensor violates timing requirements from M1.\r\n\"\"\"\r\n\r\nimport rclpy\r\nfrom rclpy.node import Node\r\nfrom rclpy.qos import QoSProfile, ReliabilityPolicy, HistoryPolicy\r\nfrom sensor_msgs.msg import Imu\r\nimport time\r\n\r\n\r\nclass ImuSubscriber(Node):\r\n    \"\"\"Subscribes to IMU data with timing monitoring.\"\"\"\r\n\r\n    def __init__(self):\r\n        super().__init__('imu_subscriber')\r\n\r\n        # Expected timing (from M1 sensor specifications)\r\n        self.expected_rate_hz = 100.0\r\n        self.max_acceptable_delay_ms = 50.0  # 5x the 10ms period\r\n\r\n        # QoS must match publisher\r\n        qos_profile = QoSProfile(\r\n            reliability=ReliabilityPolicy.BEST_EFFORT,\r\n            history=HistoryPolicy.KEEP_LAST,\r\n            depth=1\r\n        )\r\n\r\n        # Create subscription\r\n        self.subscription = self.create_subscription(\r\n            Imu,\r\n            'imu/data',\r\n            self.imu_callback,\r\n            qos_profile\r\n        )\r\n\r\n        self.last_receive_time = None\r\n        self.message_count = 0\r\n        self.late_count = 0\r\n\r\n        self.get_logger().info('IMU subscriber started')\r\n\r\n    def imu_callback(self, msg: Imu):\r\n        \"\"\"Process received IMU message.\"\"\"\r\n        receive_time = time.time()\r\n        self.message_count += 1\r\n\r\n        # Check message latency (time since message was created)\r\n        msg_time = msg.header.stamp.sec + msg.header.stamp.nanosec * 1e-9\r\n        current_ros_time = self.get_clock().now().nanoseconds * 1e-9\r\n        latency_ms = (current_ros_time - msg_time) * 1000\r\n\r\n        if latency_ms > self.max_acceptable_delay_ms:\r\n            self.late_count += 1\r\n            self.get_logger().warn(\r\n                f'IMU message late: {latency_ms:.1f}ms '\r\n                f'(threshold: {self.max_acceptable_delay_ms}ms)'\r\n            )\r\n\r\n        # Check inter-message timing\r\n        if self.last_receive_time is not None:\r\n            delta_ms = (receive_time - self.last_receive_time) * 1000\r\n            expected_period_ms = 1000.0 / self.expected_rate_hz\r\n\r\n            if delta_ms > expected_period_ms * 2:  # More than 2x expected\r\n                self.get_logger().warn(\r\n                    f'IMU gap detected: {delta_ms:.1f}ms '\r\n                    f'(expected: {expected_period_ms:.1f}ms)'\r\n                )\r\n\r\n        self.last_receive_time = receive_time\r\n\r\n        # Process the data (example: compute acceleration magnitude)\r\n        accel_magnitude = (\r\n            msg.linear_acceleration.x ** 2 +\r\n            msg.linear_acceleration.y ** 2 +\r\n            msg.linear_acceleration.z ** 2\r\n        ) ** 0.5\r\n\r\n        # Log periodically\r\n        if self.message_count % 100 == 0:\r\n            self.get_logger().info(\r\n                f'Received {self.message_count} messages, '\r\n                f'{self.late_count} late, '\r\n                f'accel: {accel_magnitude:.2f} m/s\xb2'\r\n            )\r\n\r\n\r\ndef main(args=None):\r\n    rclpy.init(args=args)\r\n    node = ImuSubscriber()\r\n\r\n    try:\r\n        rclpy.spin(node)\r\n    except KeyboardInterrupt:\r\n        pass\r\n    finally:\r\n        node.destroy_node()\r\n        rclpy.shutdown()\r\n\r\n\r\nif __name__ == '__main__':\r\n    main()\n"})}),"\n",(0,i.jsx)(s.h3,{id:"callback-execution-model",children:"Callback Execution Model"}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Callbacks are called by the executor"}),". Understanding this is critical:"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"rclpy.spin(node)"})," runs the executor"]}),"\n",(0,i.jsx)(s.li,{children:"Executor checks for new messages and calls callbacks"}),"\n",(0,i.jsx)(s.li,{children:"Callbacks should be fast (don't block)"}),"\n",(0,i.jsx)(s.li,{children:"Long processing should be in separate threads"}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Physical Grounding"}),": If your callback takes 20ms and messages arrive at 100 Hz (10ms), you will fall behind. The M1 timing budget must account for callback execution time."]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"message-types",children:"Standard Message Types"}),"\n",(0,i.jsx)(s.p,{children:"ROS 2 provides standard messages for common sensor data. Use these instead of creating custom types."}),"\n",(0,i.jsx)(s.h3,{id:"common-sensor-messages",children:"Common Sensor Messages"}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Sensor (from M1)"}),(0,i.jsx)(s.th,{children:"Message Type"}),(0,i.jsx)(s.th,{children:"Key Fields"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"IMU"}),(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"sensor_msgs/Imu"})}),(0,i.jsx)(s.td,{children:"orientation, angular_velocity, linear_acceleration"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Camera"}),(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"sensor_msgs/Image"})}),(0,i.jsx)(s.td,{children:"height, width, encoding, data"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Depth Camera"}),(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"sensor_msgs/PointCloud2"})}),(0,i.jsx)(s.td,{children:"points, fields, is_dense"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"LiDAR"}),(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"sensor_msgs/LaserScan"})}),(0,i.jsx)(s.td,{children:"ranges, angle_min/max, range_min/max"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Encoder"}),(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"sensor_msgs/JointState"})}),(0,i.jsx)(s.td,{children:"name, position, velocity, effort"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Force/Torque"}),(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"geometry_msgs/WrenchStamped"})}),(0,i.jsx)(s.td,{children:"force, torque"})]})]})]}),"\n",(0,i.jsx)(s.h3,{id:"command-messages",children:"Command Messages"}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Actuator (from M1)"}),(0,i.jsx)(s.th,{children:"Message Type"}),(0,i.jsx)(s.th,{children:"Key Fields"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Mobile base"}),(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"geometry_msgs/Twist"})}),(0,i.jsx)(s.td,{children:"linear.x/y/z, angular.x/y/z"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Joint commands"}),(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"trajectory_msgs/JointTrajectory"})}),(0,i.jsx)(s.td,{children:"joint_names, points"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Pose goal"}),(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"geometry_msgs/PoseStamped"})}),(0,i.jsx)(s.td,{children:"position, orientation"})]})]})]}),"\n",(0,i.jsx)(s.h3,{id:"message-headers",children:"Message Headers"}),"\n",(0,i.jsxs)(s.p,{children:["Most sensor messages include a ",(0,i.jsx)(s.code,{children:"std_msgs/Header"}),":"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:'header:\r\n  stamp:\r\n    sec: 1234567890\r\n    nanosec: 123456789\r\n  frame_id: "camera_link"\n'})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"stamp"}),": When the data was captured (not when published)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"frame_id"}),": The coordinate frame for the data"]}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Physical Grounding"}),": The frame_id connects to URDF (Chapter 5). The timestamp enables latency tracking from M1 Chapter 4."]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"qos-practice",children:"QoS Configuration in Practice"}),"\n",(0,i.jsx)(s.h3,{id:"qos-profiles",children:"QoS Profiles"}),"\n",(0,i.jsx)(s.p,{children:"ROS 2 provides preset profiles:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:"from rclpy.qos import qos_profile_sensor_data, qos_profile_system_default\r\n\r\n# Sensor data profile: best-effort, keep last 5\r\nsensor_qos = qos_profile_sensor_data\r\n\r\n# System default: reliable, keep last 10\r\ndefault_qos = qos_profile_system_default\n"})}),"\n",(0,i.jsx)(s.h3,{id:"custom-qos",children:"Custom QoS"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:"from rclpy.qos import QoSProfile, ReliabilityPolicy, DurabilityPolicy, HistoryPolicy\r\nfrom rclpy.duration import Duration\r\n\r\n# Custom QoS for safety-critical data\r\nsafety_qos = QoSProfile(\r\n    reliability=ReliabilityPolicy.RELIABLE,\r\n    durability=DurabilityPolicy.TRANSIENT_LOCAL,\r\n    history=HistoryPolicy.KEEP_LAST,\r\n    depth=10,\r\n    deadline=Duration(seconds=0, nanoseconds=100_000_000),  # 100ms\r\n    lifespan=Duration(seconds=1)  # Messages valid for 1 second\r\n)\n"})}),"\n",(0,i.jsx)(s.h3,{id:"qos-decision-framework",children:"QoS Decision Framework"}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.strong,{children:"From M1 sensor/actuator analysis, ask:"})}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.strong,{children:"Can we tolerate missed messages?"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Yes \u2192 ",(0,i.jsx)(s.code,{children:"BEST_EFFORT"})]}),"\n",(0,i.jsxs)(s.li,{children:["No \u2192 ",(0,i.jsx)(s.code,{children:"RELIABLE"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.strong,{children:"What data do late subscribers need?"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Just new data \u2192 ",(0,i.jsx)(s.code,{children:"VOLATILE"})]}),"\n",(0,i.jsxs)(s.li,{children:["Recent history \u2192 ",(0,i.jsx)(s.code,{children:"TRANSIENT_LOCAL"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.strong,{children:"Is there a timing deadline?"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Yes \u2192 Set ",(0,i.jsx)(s.code,{children:"deadline"})," to the maximum acceptable delay"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.strong,{children:"Can stale data cause problems?"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Yes \u2192 Set ",(0,i.jsx)(s.code,{children:"lifespan"})," to data validity period"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"debugging",children:"Debugging Topic Communication"}),"\n",(0,i.jsx)(s.h3,{id:"check-topic-existence",children:"Check Topic Existence"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"# List all topics\r\nros2 topic list\r\n\r\n# Check if specific topic exists\r\nros2 topic list | grep imu\n"})}),"\n",(0,i.jsx)(s.h3,{id:"check-message-type",children:"Check Message Type"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"# Show topic info\r\nros2 topic info /imu/data\r\n\r\n# Show message type definition\r\nros2 interface show sensor_msgs/msg/Imu\n"})}),"\n",(0,i.jsx)(s.h3,{id:"monitor-data",children:"Monitor Data"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"# Echo messages\r\nros2 topic echo /imu/data\r\n\r\n# Check rate\r\nros2 topic hz /imu/data\r\n\r\n# Check bandwidth\r\nros2 topic bw /imu/data\n"})}),"\n",(0,i.jsx)(s.h3,{id:"diagnose-qos-issues",children:"Diagnose QoS Issues"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"# Verbose topic info shows QoS\r\nros2 topic info /imu/data --verbose\n"})}),"\n",(0,i.jsx)(s.p,{children:"Common issues:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"No messages received"}),": QoS mismatch (e.g., ",(0,i.jsx)(s.code,{children:"RELIABLE"})," subscriber, ",(0,i.jsx)(s.code,{children:"BEST_EFFORT"})," publisher)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Intermittent messages"}),": Network issues or publisher crashes"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Old data"}),": Check timestamps, might be replayed data"]}),"\n"]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"cmd-vel-example",children:"Command Velocity Publisher Example"}),"\n",(0,i.jsx)(s.p,{children:"Publishing actuator commands requires different considerations than sensor data."}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:'#!/usr/bin/env python3\r\n"""\r\nVelocity Command Publisher\r\n\r\nPublishes velocity commands with safety constraints.\r\nPhysical grounding: Rate limits from M1 Chapter 3 actuator specs.\r\n"""\r\n\r\nimport rclpy\r\nfrom rclpy.node import Node\r\nfrom rclpy.qos import QoSProfile, ReliabilityPolicy, DurabilityPolicy\r\nfrom rclpy.duration import Duration\r\nfrom geometry_msgs.msg import Twist\r\n\r\n\r\nclass VelocityPublisher(Node):\r\n    """Publishes velocity commands with physical safety limits."""\r\n\r\n    def __init__(self):\r\n        super().__init__(\'velocity_publisher\')\r\n\r\n        # Physical limits from M1 actuator specifications\r\n        self.max_linear_vel = 1.0  # m/s\r\n        self.max_angular_vel = 1.0  # rad/s\r\n        self.command_rate_hz = 10.0  # Commands at 10 Hz\r\n\r\n        # QoS for commands:\r\n        # - Best-effort: if a command is missed, next one comes soon\r\n        # - Short lifespan: stale commands are dangerous\r\n        qos_profile = QoSProfile(\r\n            reliability=ReliabilityPolicy.BEST_EFFORT,\r\n            durability=DurabilityPolicy.VOLATILE,\r\n            lifespan=Duration(seconds=0, nanoseconds=200_000_000)  # 200ms\r\n        )\r\n\r\n        self.publisher = self.create_publisher(\r\n            Twist,\r\n            \'cmd_vel\',\r\n            qos_profile\r\n        )\r\n\r\n        # Timer for periodic commands\r\n        self.timer = self.create_timer(\r\n            1.0 / self.command_rate_hz,\r\n            self.publish_command\r\n        )\r\n\r\n        self.target_linear = 0.0\r\n        self.target_angular = 0.0\r\n\r\n        self.get_logger().info(\'Velocity publisher started\')\r\n\r\n    def set_velocity(self, linear: float, angular: float):\r\n        """Set target velocity with safety clamping."""\r\n        self.target_linear = max(-self.max_linear_vel,\r\n                                  min(self.max_linear_vel, linear))\r\n        self.target_angular = max(-self.max_angular_vel,\r\n                                   min(self.max_angular_vel, angular))\r\n\r\n    def publish_command(self):\r\n        """Publish velocity command."""\r\n        msg = Twist()\r\n        msg.linear.x = self.target_linear\r\n        msg.angular.z = self.target_angular\r\n\r\n        self.publisher.publish(msg)\n'})}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Physical Grounding"}),":"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Maximum velocities come from M1 actuator specifications"}),"\n",(0,i.jsx)(s.li,{children:"Short lifespan ensures stale commands don't move the robot"}),"\n",(0,i.jsx)(s.li,{children:"10 Hz rate matches typical control loop requirements"}),"\n"]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"summary",children:"Summary"}),"\n",(0,i.jsx)(s.p,{children:"This chapter covered implementing publishers and subscribers for sensor data:"}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Publishers"})," stream data at rates matching physical sensor characteristics, with timestamps and covariance from M1 noise models."]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Subscribers"})," process data in callbacks, monitoring timing to detect when physical requirements are violated."]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Standard message types"})," exist for common sensors and actuators\u2014use them."]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"QoS configuration"})," directly implements M1 physical constraints: deadline for timing, reliability for data criticality."]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Debugging tools"})," (",(0,i.jsx)(s.code,{children:"ros2 topic hz"}),", ",(0,i.jsx)(s.code,{children:"echo"}),", ",(0,i.jsx)(s.code,{children:"info --verbose"}),") help diagnose communication issues."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"self-assessment-questions",children:"Self-Assessment Questions"}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"QoS Design"}),": You have a LiDAR producing scans at 10 Hz. A mapping algorithm needs all scans. What QoS would you configure for publisher and subscriber?"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Callback Timing"}),": Your callback takes 50ms to process each message. Messages arrive at 20 Hz (50ms apart). What will happen? How would you fix it?"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Message Selection"}),": You need to publish force sensor data (3-axis force, 3-axis torque). What standard message type would you use?"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Timestamp Usage"}),": Your subscriber receives a message with a timestamp 100ms in the past. What might cause this, and how would you handle it?"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Debug Scenario"}),": A subscriber receives no messages, but ",(0,i.jsx)(s.code,{children:"ros2 topic echo"})," shows the topic has data. What is the most likely cause?"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsx)(s.h2,{id:"whats-next",children:"What's Next"}),"\n",(0,i.jsxs)(s.p,{children:["In ",(0,i.jsx)(s.a,{href:"/module-2/chapter-3-services",children:"Chapter 3: Services"}),", you'll implement the request/response pattern for discrete operations like calibration and gripper control."]})]})}function h(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453(e,s,r){r.d(s,{R:()=>a,x:()=>l});var n=r(6540);const i={},t=n.createContext(i);function a(e){const s=n.useContext(t);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),n.createElement(t.Provider,{value:s},e.children)}}}]);